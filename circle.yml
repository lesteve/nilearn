dependencies:
  cache_directories:
    - "~/nilearn_data"

  pre:
    # We need to remove conflicting texlive packages.
    - sudo -E apt-get -yq remove texlive-binaries --purge
    # Installing required packages for `make -C doc check command` to work.
    - sudo -E apt-get -yq update
    - sudo -E apt-get -yq --no-install-suggests --no-install-recommends --force-yes install dvipng texlive-latex-base texlive-latex-extra

  override:
    - export DISTRIB="conda" PYTHON_VERSION="2.7" NUMPY_VERSION="1.8.2" SCIPY_VERSION="0.13.3" SCIKIT_LEARN_VERSION="0.14.1" MATPLOTLIB_VERSION="1.1.1"
    - source continuous_integration/install.sh
    - conda install sphinx==1.2.3 coverage pillow
    # we need to do this here so the datasets will be cached
    # pipefail is necessary to propagate exit codes
    - set -o pipefail && cd doc && make html-strict 2>&1 | tee ~/log.txt

test:
  override:
    - make clean test test-coverage
    # workaround - make html returns 0 even if examples fail to build
    # (see https://github.com/sphinx-gallery/sphinx-gallery/issues/45)
    - cat ~/log.txt && if grep -q "Traceback (most recent call last):" ~/log.txt; then false; else true; fi

general:
  artifacts:
    - "doc/_build/html"
    - "coverage"
    - "~/log.txt"
